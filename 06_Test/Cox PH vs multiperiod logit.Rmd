---
title: "Cox PH vs multiperiod logit"
author: "Andrej Sokolič"
params: 
  printcode: FALSE
  printresults: hide
  figshow: hide
  displaywarnings : FALSE
  evalForSol: TRUE
  d: !r Sys.Date() 
  msgshow: FALSE
output:
  html_document: default
  pdf_document: default
---

```{r, setup, include=FALSE}
# set this option in the first code chunk in the document
knitr::opts_chunk$set(echo = params$printcode, results= params$printresults, fig.show = params$figshow, warning = params$displaywarnings, eval=params$evalForSol, message = params$msgshow,
                      fig.align='center')
```


Dokument pripravljen z verzijo R-a `r getRversion()`. Danasnji datum je `r params$d`.

[https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf](Vir)


```{r libraries, message = FALSE, warning = FALSE}
library(tidyverse)
library(survival)
```


```{r}
data("cgd0")

head(cgd0)
```

data1: the primary data set, to which new variables and/or observation will be added
data2: second data set in which all the other arguments will be found
tstop: optional variable to define the valid time range for each subject, only used on an initial call

```{r}
newcgd <- tmerge(data1=cgd0[, 1:13], data2=cgd0, id=id, tstop=futime)
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime1))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime2))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime3))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime4))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime5))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime6))
newcgd <- tmerge(newcgd, cgd0, id=id, infect = event(etime7))
newcgd <- tmerge(newcgd, newcgd, id, enum=cumtdc(tstart))
head(newcgd)

# ALI

test <- tmerge(cgd0[, 1:13], cgd0, id=id, tstop=futime,
infect = event(etime1), infect= event(etime2),
infect = event(etime3), infect= event(etime4),
infect = event(etime5), infect= event(etime6),
infect = event(etime7))
test <- tmerge(test, test, id= id, enum = cumtdc(tstart))
all.equal(newcgd, test)
```


```{r}
Fit_CPH <- coxph(Surv(tstart, tstop, infect) ~ treat + inherit + steroids +
+ cluster(id), newcgd)

summary(Fit_CPH)
```


Tukaj v bistvu zelo visoki `tstop`. Diskretna porazdelitev časov bi bila zelo široka. Mogoče boljše uporabiti npr. mesece.

```{r}
range(newcgd$futime)

Data <- newcgd
Data$futime <- round(Data$futime / 30)
Data$tstart2 <- ceiling(Data$tstart / 30)
Data$tstop2 <- ceiling(Data$tstop / 30)
Data$tstart2[Data$tstart2 == Data$tstop2] <- Data$tstart2[Data$tstart2 == Data$tstop2] - 1
```


Ta ni ok, imajo večkrat infect = 1

```{r}
Data %>% group_by(id) %>% summarise(sum(infect))
```


## HEART DATA

```{r}
head(heart)
```

Je že v ok formatu.

```{r}
Fit_CPH <- coxph(Surv(start, stop, event) ~ age + surgery + transplant +
+ cluster(id), heart)

summary(Fit_CPH)
```


```{r}
range(heart$start)
range(heart$stop)
```

